<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title></title>
<style>

    .node {
        stroke:rgb(0,0,0);
        stroke-width: 0.5px;
    }

    .node.project {
        fill: rgb(255,128,128);
    }

    .node.person {
        fill: rgb(128,255,128);
    }

    .node.company {
        fill: rgb(128,128,255);
    }

    .node.usergroup {
        fill: rgb(120,48,25);
    }

    .node.podcast {
        fill: rgb(255,255,255);
    }

    .link {
        stroke: #999;
        stroke-opacity: .6;
    }

</style>

<body>
<link rel="stylesheet" href="bower_components/tipsy/src/stylesheets/tipsy.css"/>
<script src="bower_components/d3/d3.js"></script>
<script src="bower_components/jquery/dist/jquery.min.js"></script>
<script src="bower_components/tipsy/src/javascripts/jquery.tipsy.js"></script>
<script>

    var width = 960, height = 500;

    var color = d3.scale.category20();

    var svg = d3.select("body").append("svg")
            .attr("width", width)
            .attr("height", height);

    var node = svg.selectAll('.node'),
        link = svg.selectAll('.link');

    console.log(link);

    var force = d3.layout.force()
            .charge(-120)
            .linkDistance(30)
            .size([width, height])
            .on('tick', function () {
                link.attr("x1", function (d) {
                            return d.source.x;
                        })
                        .attr("y1", function (d) {
                            return d.source.y;
                        })
                        .attr("x2", function (d) {
                            return d.target.x;
                        })
                        .attr("y2", function (d) {
                            return d.target.y;
                        });

                node.attr("cx", function (d) {
                            return d.x;
                        })
                        .attr("cy", function (d) {
                            return d.y;
                        });
            });

    var nodeMap = {};
    var linkMap = {};
    var myNodes = [];
    var myLinks = [];


    drawContentByUri = function(uri) {
        d3.json(uri, function (error, graph) {
            if (error) {
                console.log(error);
                throw error;
            }

            graph.nodes.forEach(function(x) {
                nodeMap[x.name] = x;
            });

            myNodes = force.nodes();
            myLinks = force.links();
            for (i in graph.nodes) {
                x = graph.nodes[i];
                result = myNodes.filter(function(k){
                    if (x.name == k.name) {
                        return true;
                    }
                    return false;
                });
                if (result.length == 0) {
                    myNodes.push(x);
                }
            }

            for(i in graph.links) {
                x = graph.links[i];
                result = myLinks.filter(function(k){
                    if (! k.source || !k.target) {
                        return false;
                    }
                    return x.source == k.source.name && x.target == k.target.name;
                });
                if (result.length == 0) {

                    target = myNodes.filter(function(k){
                        return k.name == this.target;
                    }.bind(x));
                    source = myNodes.filter(function(k){
                        return k.name == this.source;
                    }.bind(x));
                    mlink = {
                        source : source[0],
                        target : target[0],
                        value : 1
                    };
                    myLinks.push(mlink);
                }
            }

            force
                    .nodes(myNodes)
                    .links(myLinks)
                    .start();

            tickmap = d3.map();
console.log(link);
            link = link.data(force.links(), function(d){
                return d.target.name + '_' + d.source.name;
            });

            link.enter().insert("line", '.node')
                    .attr("class", "link");
            link.exit().remove();

            node = node.data(force.nodes(), function(d){
                return d.name;
            });

            node.enter().append("circle")
                    .attr("class", function(d) {
                        return "node " + d.type;
                    })
                    .attr("r", 5);
            node.exit().remove();

            force.start();

            node.on('click', function(){
                drawContentByUri("PHPamily3.json");
            });

            $('svg circle').tipsy({
                gravity : 'se',
                html    : true,
                title   : function () {
                    var d = this.__data__;
                    return 'Hi there! I am ' + d.name;
                }
            });


        });
    }
    drawContentByUri("PHPamily2.json");

    $('svg circle').tipsy({
        gravity : 'se',
        html    : true,
        title   : function () {
            var d = this.__data__;
            return 'Hi there! I am ' + d.name;
        }
    });

    $('svg line').tipsy({
        gravity : 'se',
        html    : true,
        title   : function () {
            var d = this.__data__;
            return 'Hi there! I am ' + d.value;
        }
    });

</script>